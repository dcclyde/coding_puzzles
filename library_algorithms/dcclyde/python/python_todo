Here's a segtree implementation from `conqueror_of_tourist`:
https://codeforces.com/contest/1718/submission/168567864

not sure if it'd have trouble if I made a lazy version though.

.
